name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

env:
  CARGO: ~/.cargo/bin/cargo
  CARGO_NIGHTLY: ~/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/bin/cargo
  RUSTC: ~/.cargo/bin/rustc

jobs:
  release-windows:
    runs-on: self-hosted
    name: Build Windows Release
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify Environment
        run: |
          echo "=== Windows Cross-Compile Build ==="
          echo "Tag: ${{ github.ref_name }}"
          $RUSTC --version
          $CARGO --version

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          key: ctl365-release-windows

      - name: Run Tests (nightly)
        run: $CARGO_NIGHTLY test

      - name: Build Windows Release
        run: $CARGO build --release --target x86_64-pc-windows-gnu

      - name: Create Windows Archive
        run: |
          set -euo pipefail
          VERSION="${{ github.ref_name }}"
          ARCHIVE_DIR="ctl365-${VERSION}-windows"
          BINARY="target/x86_64-pc-windows-gnu/release/ctl365.exe"

          mkdir -p "$ARCHIVE_DIR"
          cp "$BINARY" "$ARCHIVE_DIR/ctl365.exe"
          cp README.md "$ARCHIVE_DIR/" 2>/dev/null || true
          cp LICENSE "$ARCHIVE_DIR/" 2>/dev/null || true
          cp COMMANDS.md "$ARCHIVE_DIR/" 2>/dev/null || true
          cp release/windows/install.ps1 "$ARCHIVE_DIR/" 2>/dev/null || true
          cp release/windows/uninstall.ps1 "$ARCHIVE_DIR/" 2>/dev/null || true

          zip -r "ctl365-${VERSION}-windows-x86_64.zip" "$ARCHIVE_DIR"

          echo "=== Windows Archive Contents ==="
          unzip -l "ctl365-${VERSION}-windows-x86_64.zip"
          ls -lh "ctl365-${VERSION}-windows-x86_64.zip"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: ctl365-${{ github.ref_name }}-windows-x86_64.zip
          draft: false
          prerelease: ${{ contains(github.ref_name, 'rc') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha') }}
          generate_release_notes: true
          body: |
            ## ctl365 ${{ github.ref_name }}

            Enterprise-grade Microsoft 365 deployment automation CLI.

            ### Download

            | Platform | File |
            |----------|------|
            | **Windows** | `ctl365-${{ github.ref_name }}-windows-x86_64.zip` |

            ### Quick Install (PowerShell)

            ```powershell
            Expand-Archive ctl365-${{ github.ref_name }}-windows-x86_64.zip -DestinationPath .
            .\ctl365-${{ github.ref_name }}-windows\ctl365.exe --version
            # Or run install.ps1 to add to PATH
            ```

            ### Documentation

            - [Getting Started](https://github.com/resotech/ctl365/blob/main/GETTING_STARTED.md)
            - [Command Reference](https://github.com/resotech/ctl365/blob/main/COMMANDS.md)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Summary
        run: |
          echo "### Release ${{ github.ref_name }} âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Size |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| Windows | $(ls -lh ctl365-${{ github.ref_name }}-windows-x86_64.zip | awk '{print $5}') |" >> $GITHUB_STEP_SUMMARY
