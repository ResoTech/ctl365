name: Nightly Build

on:
  schedule:
    - cron: '30 7 * * *'  # 7:30 AM UTC daily
  workflow_dispatch:

jobs:
  nightly:
    name: "Nightly validation"
    runs-on: self-hosted
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify Environment
        run: |
          set -euo pipefail
          echo "=== Nightly Build $(date -u +%Y-%m-%d) ==="
          rustc --version
          cargo --version

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          key: ctl365-nightly

      - name: Full build
        run: cargo build --release

      - name: Full test sweep
        run: cargo test

      - name: Clippy strict
        run: |
          cargo clippy --release -- \
            -W clippy::all \
            -W clippy::pedantic \
            -A clippy::needless-borrows-for-generic-args \
            -A clippy::single-char-add-str \
            -A clippy::redundant-field-names \
            -A clippy::module-name-repetitions \
            -A clippy::too-many-lines \
            -A clippy::missing-errors-doc \
            -A clippy::missing-panics-doc \
            -A clippy::must-use-candidate \
            -A clippy::struct-excessive-bools

      - name: Format check
        run: cargo fmt --check

      - name: Extended CLI Tests
        run: |
          set -euo pipefail
          CTL365=$(find target -path "*/release/ctl365" -type f -executable | head -1)

          echo "=== Extended CLI Tests ==="
          $CTL365 --version
          $CTL365 --help

          echo ""
          echo "=== All Subcommands ==="
          for cmd in tenant baseline ca autopilot app audit export sharepoint viva copilot scuba gpo script tui; do
            echo "Testing: $cmd"
            $CTL365 $cmd --help > /dev/null
          done

          echo ""
          echo "=== Repeated queries (stability check) ==="
          for i in 1 2 3 4 5; do
            $CTL365 baseline list > /dev/null 2>&1 || true
            echo "Query $i: OK"
          done

          echo ""
          echo "✅ Extended CLI tests passed"

      - name: Binary size check
        run: |
          set -euo pipefail
          CTL365=$(find target -path "*/release/ctl365" -type f -executable | head -1)
          SIZE=$(stat -c%s "$CTL365" 2>/dev/null || stat -f%z "$CTL365")
          SIZE_MB=$((SIZE / 1024 / 1024))
          echo "Binary size: ${SIZE_MB}MB ($SIZE bytes)"
          if [ "$SIZE_MB" -gt 100 ]; then
            echo "::warning::Binary size exceeds 100MB"
          fi

      - name: Nightly Summary
        run: |
          echo "### Nightly Build $(date -u +%Y-%m-%d) ✅" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ✅ |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ✅ |" >> $GITHUB_STEP_SUMMARY
          echo "| Clippy (pedantic) | ✅ |" >> $GITHUB_STEP_SUMMARY
          echo "| CLI Tests | ✅ |" >> $GITHUB_STEP_SUMMARY
          echo "| Binary | $(find target -path '*/release/ctl365' -type f -executable -exec ls -lh {} \; | awk '{print $5}' | head -1) |" >> $GITHUB_STEP_SUMMARY
