name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO: ~/.cargo/bin/cargo
  CARGO_NIGHTLY: ~/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/bin/cargo
  RUSTC: ~/.cargo/bin/rustc
  RUSTFMT: ~/.cargo/bin/rustfmt

jobs:
  build-and-test:
    runs-on: self-hosted
    name: Build & Test (nv-osmium)
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify Environment
        run: |
          echo "=== Rust Toolchain ==="
          $RUSTC --version
          $CARGO --version

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          key: ctl365-ci

      - name: Build Release
        run: $CARGO build --release

      - name: Clippy (zero warnings)
        run: $CARGO clippy --release -- -D warnings

      - name: Format Check
        run: $CARGO fmt --check

      - name: Unit Tests (nightly for wiremock)
        run: $CARGO_NIGHTLY test

      - name: CLI Smoke Test
        run: |
          set -euo pipefail
          CTL365=$(find target -path "*/release/ctl365" -type f -executable | head -1)

          echo "=== Basic Commands ==="
          $CTL365 --version
          $CTL365 --help > /dev/null

          echo ""
          echo "=== Command Help ==="
          $CTL365 tenant --help > /dev/null
          $CTL365 baseline --help > /dev/null
          $CTL365 ca --help > /dev/null
          $CTL365 autopilot --help > /dev/null

          echo ""
          echo "=== Baseline List ==="
          $CTL365 baseline list || true

          echo ""
          echo "✅ CLI smoke tests passed"

      - name: CLI Test Suite
        run: |
          set -euo pipefail
          CTL365=$(find target -path "*/release/ctl365" -type f -executable | head -1)
          PASSED=0
          FAILED=0

          test_cmd() {
            local name="$1"
            local cmd="$2"
            if $CTL365 $cmd > /dev/null 2>&1; then
              echo "✅ $name"
              PASSED=$((PASSED + 1))
            else
              echo "❌ $name"
              FAILED=$((FAILED + 1))
            fi
          }

          echo "=== CLI Commands ==="
          test_cmd "version" "--version"
          test_cmd "help" "--help"
          test_cmd "tenant help" "tenant --help"
          test_cmd "baseline help" "baseline --help"
          test_cmd "baseline list" "baseline list"
          test_cmd "ca help" "ca --help"
          test_cmd "autopilot help" "autopilot --help"
          test_cmd "app help" "app --help"
          test_cmd "audit help" "audit --help"
          test_cmd "sharepoint help" "sharepoint --help"
          test_cmd "viva help" "viva --help"
          test_cmd "copilot help" "copilot --help"
          test_cmd "scuba help" "scuba --help"
          test_cmd "tui help" "tui --help"

          echo ""
          echo "Results: $PASSED passed, $FAILED failed"

          if [[ $FAILED -gt 0 ]]; then
            exit 1
          fi

      - name: Build Summary
        run: |
          echo "### Build Complete ✅" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Binary | $(find target -path '*/release/ctl365' -type f -executable -exec ls -lh {} \; | awk '{print $5}' | head -1) |" >> $GITHUB_STEP_SUMMARY
          echo "| Rust | $($RUSTC --version | cut -d' ' -f2) |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | Passed |" >> $GITHUB_STEP_SUMMARY
